generateMatrixLive=function(){var homeserverWithoutHTTPS=$("#homeserver").val(),initialLoadRaw=$("#initial_load").val(),pageTitle=$("#page_title").val(),config={homeserver:"https://"+homeserverWithoutHTTPS,room:$("#room").val(),initial_load:$.isNumeric(initialLoadRaw)?initialLoadRaw:60},generateButtonText=$("#generate-button").val();$("#generate-button").prop("disabled",!0),$("#generate-button").val("Testing - Please wait and see progress below..."),$(".generate-results").addClass("generate-hidden"),$(".generate-progress").html(""),logProgress("msg","Trying to obtain guest access from homeserver "+config.homeserver+"..."),testAccessToken(config).then(function(access_token){return logProgress("msg","Successfully obtained guest access token."),logProgress("msg","Trying to retrieve room preview for room "+config.room+"..."),testInitialSync(access_token,config)}).then(function(){var urlMatch,myPath;logProgress("msg","Successfully obtained room preview."),logProgress("success","We have successfully tested your configuration. Please find the Matrix Live link and embed code below."),myPath=(urlMatch=window.location.href.split("#")[0].match(/^(.+)\/(.*?)$/))?urlMatch[1]:"https://live.hello-matrix.net",$(".generate-link").html('<a href="'+myPath+"/live.html#"+encodeURIComponent(homeserverWithoutHTTPS)+"/"+encodeURIComponent(config.room)+(""!==pageTitle?"/"+encodeURIComponent(pageTitle):"")+'" target="_blank">Matrix Live</a>'),""!==$("#page_title").val()&&$(".generate-link a").text($("#page_title").val()),$(".generate-code").text('<matrix-live homeserver="https://'+homeserverWithoutHTTPS+'"\n             room="'+config.room+'"'+($.isNumeric(initialLoadRaw)?'\n             initial-load="'+initialLoadRaw+'"':"")+"></matrix-live>"),$(".generate-code-bottom").text(($("#jquery-yes").prop("checked")?'<script src="https://code.jquery.com/jquery-3.1.1.min.js"\n        integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="\n        crossorigin="anonymous"><\/script>\n':"")+'<script src="'+myPath+'/matrix-live-min.js"><\/script>'),$(".generate-code-css").text('<link rel="stylesheet" type="text/css" href="'+myPath+'/matrix-live.css">'),$(".generate-results").removeClass("generate-hidden"),$(".generate-results").get(0).scrollIntoView(),$("#generate-button").prop("disabled",!1),$("#generate-button").val(generateButtonText)}).fail(function(err){logProgress("error",err),$("#generate-button").prop("disabled",!1),$("#generate-button").val(generateButtonText)})};var logProgress=function(type,text){var myLi=$('<li class="generate-progress-'+type+'"></li>');myLi.text(text),$(".generate-progress").append(myLi),myLi.get(0).scrollIntoView()},testAccessToken=function(config){return $.Deferred(function(defer){$.ajax({url:config.homeserver+"/_matrix/client/r0/register?kind=guest",type:"POST",contentType:"application/json",data:'{ "initial_device_display_name": "Matrix Live Reader" }',processData:!1,dataType:"json"}).then(function(res){res.access_token?defer.resolve(res.access_token):(console.log("Received strange response from matrix: "),console.log(res),defer.reject("The homeserver did not provide an access token. Maybe the domain is wrong or guest access is disabled?"))},function(err){console.log("Received error from request when contacting homeserver: "),console.log(err),0===err.status?defer.reject("No homeserver responds at the given domain. Are you sure this is the valid domain? Can you connect with Riot and a custom URL of https://"+config.homeserver+"/?"):403===err.status?defer.reject("The homeserver does not provide guest access tokens. Are you sure that guest access is enabled?"):err.status>=400&&err.status<=499?defer.reject("No homeserver API responded at the given domain. Are you sure this is the valid domain?"):err.status>=500?defer.reject("The homeserver responded with an internal error. Are you sure it is working properly? Is the domain correct?"):defer.reject("The homeserver did not provide an access token. Maybe the domain is wrong or guest access is disabled?")})}).promise()},testInitialSync=function(access_token,config){return $.Deferred(function(defer){$.ajax({url:config.homeserver+"/_matrix/client/r0/rooms/"+encodeURIComponent(config.room)+"/initialSync?limit="+config.initial_load+"&access_token="+encodeURIComponent(access_token),type:"GET",dataType:"json"}).then(function(res){res.messages&&res.messages.chunk&&Array.isArray(res.messages.chunk)&&res.state&&Array.isArray(res.state)?defer.resolve():(console.log("Received strange response from matrix: "),console.log(res),defer.reject("The homeserver did not return room contents. Maybe the room ID is wrong or the room does not allow Room Previews?"))},function(err){console.log("Received error from request when trying initial sync: "),console.log(err),defer.reject("The homeserver did not return room contents. Maybe the room ID is wrong or the room does not allow Room Previews?")})}).promise()};